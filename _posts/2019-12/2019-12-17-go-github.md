---
layout: post
title:  "Goè°ƒç”¨github api"
date:   2019-12-17 20:45:00 +0800
categories: Go
tags: Go-Language
excerpt: Goè°ƒç”¨github api
mathjax: true
typora-root-url: ../
---

# Github client

å¯¹githubçš„æ“ä½œï¼Œè½å®åˆ°ä»£ç é‡Œï¼Œæ¯”å¦‚æƒ³è¦å»createrepo, clone, commit, pullrequestç­‰ï¼Œéœ€è¦call github restful api [[1]](https://developer.github.com/v3/)

å½“ç„¶å¯ä»¥è‡ªå·±ä»é›¶å†™èµ·ï¼Œä½†æ˜¯æœ‰ä¸€äº›åº“å·²ç»å¸®æˆ‘ä»¬å°è£…äº†è¿™äº›æ“ä½œï¼Œæ˜¯å¯ä»¥æ‹¿æ¥ç”¨ä¸€ä¸‹çš„ã€‚æ¯”å¦‚`http://gopkg.in/src-d/go-git.v4`ï¼Œæ¯”å¦‚`k8s.io/test-infra/prow`

> Prow is a Kubernetes based CI/CD system. Jobs can be triggered by various types of events and report their status to many different services. In addition to job execution, Prow provides GitHub automation in the form of policy enforcement, chat-ops via `/foo` style commands, and automatic PR merging.

æ¥å£å°è£…çš„è¿˜ç®—æ¯”è¾ƒå…¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨prowå°è£…å¥½çš„æ¥è¯•ä¸€ä¸‹ï¼Œä¸‹é¢è¿™ä¸¤ä¸ªå¯ä»¥ç”¨ä¸€ä¸‹ï¼š

* gitï¼šk8s.io/test-infra/prow/gitï¼Œè¿™é‡Œé¢æ˜¯ä¸€äº›åŸºç¡€çš„gitçš„æ“ä½œï¼Œæ¯”å¦‚clone, checkout, forkå•¥çš„
* githubï¼šk8s.io/test-infra/prow/githubï¼Œè¿™é‡Œé¢æ˜¯ä¸€äº›githubçš„æ“ä½œï¼Œæ¯”å¦‚createpullrequestå‘€ï¼Œlistprå•¥çš„

è¿™ä¸¤ä¸ªåº“çš„ä½¿ç”¨éœ€è¦å…ˆnewä¸€ä¸ªclientï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„githubåº“ï¼Œè€Œé»˜è®¤æ˜¯github.comï¼Œæ‰€ä»¥å¯¹äºgitï¼š

```
import 	prowgit "k8s.io/test-infra/prow/git"

gitclient,_ := prowgit.NewClientWithHost("wwwin-github.cisco.com")
gitclient.SetCredentials("minsu", gettoken)
```

å¯¹äºgithub

```go
import prowgithub "k8s.io/test-infra/prow/github"

githubclient := prowgithub.NewClient(gettoken, censor, prowgithub.DefaultGraphQLEndpoint, "https://wwwin-github.cisco.com/api/v3")
```

# Create Pull Request

åœ¨æˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯é‡Œï¼Œæœ‰ä¸€ä¸ªéœ€æ±‚æ˜¯å¸Œæœ›å¯ä»¥ä¿®æ”¹githubä¸Šçš„yamlæ–‡ä»¶ï¼Œä¿®æ”¹å…¶ä¸­ä¸€äº›å­—æ®µï¼Œç„¶åæpull requestè¿›è¡Œä¿®æ”¹ï¼Œå†™äº†ä¸€äº›æµ‹è¯•ä»£ç å°è¯•ä¸€ä¸‹è¿™ä¸ªæµç¨‹

æ•´ä¸ªæ­¥éª¤ï¼Œè·Ÿæˆ‘ä»¬æ‰‹å·¥æ“ä½œçš„æ­¥éª¤æ˜¯ä¸€æ ·çš„:

* åˆ›å»ºä¸€ä¸ªforkçš„repoå¹¶clone

```go
githubclient.CreateFork(ORG, REPO)
```

* æŠŠæˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„branch checkoutå‡ºæ¥ï¼ˆä»£ç æ˜¯ç¼“å­˜åœ¨æœ¬åœ°ä¸´æ—¶ç›®å½•çš„ï¼‰

```go
repo, _ := gitclient.Clone("minsu", REPO)
repo.Checkout("master")
```

* åˆ›å»ºä¸€ä¸ªæ–°çš„branchç”¨äºä¿®æ”¹ä»£ç 

```go
repo.CheckoutNewBranch("test")
```

* fetch upstream

```go
gitCommand(repo.Directory(), "remote", "add", "upstream", "https://"+OKEAPPGITHUB+"/"+ORG+"/"+REPO+".git")
gitCommand(repo.Directory(), "fetch", "upstream")
gitCommand(repo.Directory(), "merge", "upstream/oke-guard-qa")

func gitCommand(dir string, arg ...string) {
	git, _ := exec.LookPath("git")
	cmd := exec.Command(git, arg...)
	cmd.Dir = dir
	out, err := cmd.CombinedOutput()
	if err != nil {
		fmt.Println("command exec failed", err)
		return
	}
}
```

* ä¿®æ”¹æœ¬åœ°ä½ æƒ³è¦ä¿®æ”¹çš„ä»£ç 

```go
import "sigs.k8s.io/yaml"

yamlFile, _ := ioutil.ReadFile(repo.Directory() + "/" + "application.yaml")
var a Application
yaml.UnmarshalStrict(yamlFile, &a)
yamlContent, _ := json.Marshal(a)

a.Spec.Project = "iaas1"  //ä¿®æ”¹ä¸€ä¸ªå€¼ï¼Œå†å†™å›å»
changedContent, _ := yaml.Marshal(a)
ioutil.WriteFile(repo.Directory() + "/" + "application.yaml", changedContent, 0644)
```

* pushä½ çš„ä»£ç åˆ°forkä¸­çš„æ–°branch

prowçš„gitåº“æœ¬æ¥æ˜¯æä¾›äº†pushçš„åŠŸèƒ½çš„ï¼Œå¯æ˜¯å†™æ­»äº†github.com...å±…ç„¶æ²¡ç”¨æˆ‘ä»¬ä¼ è¿›å»çš„hostï¼Œæ˜¯æ•…æ„çš„ä¹ˆğŸ˜“

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå»forkçš„repoçœ‹ï¼Œä»£ç å·²ç»commitæä¸Šå»äº†

```go
Push_toCiscoGithub(*repo, REPO, "test")

func Push_toCiscoGithub(r prowgit.Repo, repo, branch string) error {
	remote := fmt.Sprintf("https://%s:%s@%s/%s/%s", "minsu", gettoken(), OKEAPPGITHUB, "minsu", repo)
	git, _ := exec.LookPath("git")
	x := exec.Command(git, "commit", "-a", "-m", "test commit")
	x.Dir = r.Directory()

	cmd := exec.Command(git, "push", remote, branch)
	cmd.Dir = r.Directory()
	out, err := cmd.CombinedOutput()
	if err != nil {
		return fmt.Errorf("pushing failed, output: %q, error: %v", string(out), err)
	}
	return nil
}
```

* æpr

githubåº“é‡Œæä¾›CreatePullRequestä¹Ÿä¸èƒ½workï¼Œä¹Ÿæ²¡åŠæ³•æ”¹ï¼Œå°è£…åœ¨é‡Œé¢äº†ï¼Œä¸€ç›´æŠ¥

> INFO[0009] CreatePullRequest(webex-iaas, okeguard-OpenKubernetsEngine-cicd, test pr) client=github
> create pull request error status code 422 not one of [201], body: {"message":"Invalid request.\n\nFor 'links/0/schema', nil is not an object.","documentation_url":"https://developer.github.com/enterprise/2.16/v3/pulls/#create-a-pull-request"}

å…¥å‚éƒ½æ£€æŸ¥äº†æ²¡é—®é¢˜ï¼Œåæ¥æ‰‹å·¥å°è¯•äº†callï¼ŒåŒæ ·çš„å‚æ•°éƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚ã€‚

è¿™æ ·å°±å®ç°äº†è‡ªåŠ¨æäº¤pull requestäº†ï¼ŒæŠ˜è…¾äº†æˆ‘ä¸¤å¤©ğŸ˜¢

```go
url := fmt.Sprintf("%s/repos/%s/%s/pulls", "https://wwwin-github.cisco.com/api/v3", ORG, REPO)
data := struct {
   Title string `json:"title"`
   Body  string `json:"body"`
   Head  string `json:"head"`
   Base  string `json:"base"`
   // MaintainerCanModify allows maintainers of the repo to modify this
   // pull request, eg. push changes to it before merging.
   MaintainerCanModify bool `json:"maintainer_can_modify"`
}{
   Title: "test pr",
   Body:  "this is a test pr",
   Head:  "minsu:test",
   Base:  "master",

   MaintainerCanModify: true,
}
body, _ := json.Marshal(data)
req, _ := http.NewRequest("POST", url, bytes.NewBuffer(body))
req.SetBasicAuth("minsu", string(gettoken()))
req.Header.Add("accept", "application/vnd.github.symmetra-preview+json, application/vnd.github.shadow-cat-preview")
client := &http.Client{}
res, err := client.Do(req)
if err != nil {
   fmt.Println("pr error", e.Error())
}
fmt.Println(res.StatusCode)
```

# References

[1] [https://developer.github.com/v3/](https://developer.github.com/v3/)

[2] [https://github.com/kubernetes/test-infra/tree/master/prow]( https://github.com/kubernetes/test-infra/tree/master/prow)