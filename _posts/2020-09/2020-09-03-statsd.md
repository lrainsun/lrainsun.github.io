---
layout: post
title:  "airflow metrics"
date:   2020-09-03 23:00:00 +0800
categories: Airflow
tags: Airflow-Tutorial
excerpt: airflow metrics
mathjax: true
typora-root-url: ../
---

# airflow metrics

## [airflow_prometheus_exporter](https://github.com/robinhood/airflow-prometheus-exporter/tree/master/airflow_prometheus_exporter)

airflow prometheus exporter可以通过`pip install airflow-prometheus-exporter`安装，安装后，需要重新airflow webserver，然后就可以在`airflow_url:port/admin/metrics`得到相应的metrics

![image-20200903141401429](/../assets/images/image-20200903141401429.png)

对应在prometheus上的配置

```yaml
  - job_name: airflow
    scrape_interval: 1m
    scrape_timeout: 1m
    static_configs:
    - targets:
      - ocp-dev-003.qa.webex.com:32000
    metrics_path: /admin/metrics
```

这里有一些task status/duration, dag status/duration的metrics，看代码是从数据库里查询得到的数据

## [statsd](https://airflow.apache.org/docs/stable/metrics.html)

airflow本身是支持把metrics发送到statsd的

需要安装

```
pip install 'apache-airflow[statsd]'
```

然后要在airflow.cfg里配置

```yaml
    [scheduler]
    statsd_on = True
    statsd_host = ocp-dev-003.qa.webex.com
    statsd_port = 9125
    statsd_prefix = airflow
```

这样airflow起来后，会把metrics发送到ocp-dev-003.qa.webex.com的9125端口

所以我们还需要装一个statsd service，同时把statsd metrics做一个mapping，这里有现成的[ap-statsd-exporter](https://hub.docker.com/r/astronomerinc/ap-statsd-exporter/)

```shell
docker run -itd -p 9102:9102 --name statsd-exporter --net host astronomerinc/ap-statsd-exporter
```

起来后，可以看到会在9125监听发过来的statsd traffic，并且提供9102给prometheus暴露metrics

```shell
[root@ocp-dev-003 ocp_dags]# docker logs -f statsd-exporter
level=info ts=2020-09-03T02:35:57.474Z caller=main.go:287 msg="Starting StatsD -> Prometheus Exporter" version="(version=0.17.0, branch=HEAD, revision=b162bd047a2a052e86923eecae9918590d64f0b1)"
level=info ts=2020-09-03T02:35:57.474Z caller=main.go:288 msg="Build context" context="(go=go1.14.4, user=root@3f80877a62b8, date=20200626-15:20:35)"
level=info ts=2020-09-03T02:35:57.474Z caller=main.go:289 msg="Accepting StatsD Traffic" udp=:9125 tcp=:9125 unixgram=
level=info ts=2020-09-03T02:35:57.474Z caller=main.go:290 msg="Accepting Prometheus Requests" addr=:9102
```

![image-20200903142157872](/../assets/images/image-20200903142157872.png)

对应prometheus里的配置

```syaml
  - job_name: airflow-statsd
    scrape_interval: 1m
    scrape_timeout: 1m
    static_configs:
    - targets:
      - ocp-dev-003.qa.webex.com:9102
```

### StatsD简介

StatsD 狭义上来讲，其实就是一个监听 UDP(Default)/TCP 的守护程序。

基本分为了三步，A) 根据简单的协议收集 StatsD 客户端发送来的数据；B) 解析数据并进行聚合；C) 然后定时推送给后端，如 Graphite 和 InfluxDB 等，并通过 Grafana 等展示。

StatsD 的协议其实非常简单，每一行就是一条数据，通过换行符 `'\n'` 分割。

```shell
<metric_name/bucket>:<value>|<type>[|@sample_rate]
```

* bucket
  * bucket是一个metric的标识，可以看成一个metric的变量。
* value
  * metric的值，通常是数字。
* type
  * metric的类型，通常有**timer**、**counter**、**gauge**和**set**四种。
* sample_rate
  * 如果数据上报量过大，很容易溢满statsd。所以适当的降低采样，减少server负载。
     这个频率容易误解，需要解释一下。客户端减少数据上报的频率，然后在发送的数据中加入采样频率，如0.1。statsd server收到上报的数据之后，如cnt=10，得知此数据是采样的数据，然后flush的时候，按采样频率恢复数据来发送给backend，即flush的时候，数据为cnt=10/0.1=100，而不是容易误解的10*0.1=1。

比如我们推送一个metrics

```shell
echo "rain_test_count:1|c" | nc -w 1 -u ocp-dev-003.qa.webex.com 9125
```

就能在prometheus看到了

```shell
[root@ocp-dev-003 ocp_dags]# curl ocp-dev-003.qa.webex.com:9102/metrics | grep rain_test
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 45992    0 45992    0     0  5200# HELP rain_test_count Metric autogenerated by statsd_exporter.
k   # TYPE rain_test_count counter
   rain_test_count 1
0 --:--:-- --:--:-- --:--:-- 7485k
```

其中指标命名没有特别的限制，但是一般的约定是使用点号分割的命名空间；指标的值一般是大于等于 0 的浮点数。

StatD 通过指标类型 gauge、counting、timing、set，封装了一些最常用的操作，例如周期内指标值的累加、统计执行时间等。

#### counting

也就是计数类型，每次会对 `countor` 递加，当刷新时会将计数值发送，并重置为 0 。

```
countor:1|c
```

#### Timing

计时器的一大好处在于，可以得到平均值、总值、计数值、百分位数(Percentile)和上下限值，最终生成如下类似的值：

```
stats.timers.$KEY.mean_$PCT
stats.timers.$KEY.upper_$PCT
stats.timers.$KEY.sum_$PCT
```

#### Gauges

标量是任何可测量的一维变量，如内存、人的身高、体重等。

```
gaugor:333|g
```

如果该值在下次刷新前没有更新，那么就会发送上次的值。也可以在值前添加正负号，用于表示对值的修改，而非设置。这也就意味着，不能直接设置负值，需要先设置为 0 才可以。

```
gaugor:333|g
gaugor:-10|g
gaugor:+4|g
```

#### Sets

可以针对某一个集合进行统计，统计总共出现了多少种类的值。

```
seter:765|s
```

