---
layout: post
title:  "CPU上下文切换概述"
date:   2020-01-16 18:55:00 +0800
categories: Linux
tags: Linux-Performance
excerpt: CPU上下文切换概述
mathjax: true
typora-root-url: ../
---

# 平均负载跟CPU上下文切换

之前有学习平均负载，在CPU密集型跟I/O密集型的情况下，都会发生平均负载变高，还有一种情况，进程在等待CPU的时候也会导致平均负载升高。

那进程在等待CPU的时候并没有真正运行，为什么平均负载会升高呢？

—— 就是因为CPU上下文切换

# Linux多任务系统

Linux是多任务操作系统：多任务系统指可以同一时间内运行多个应用程序，每个应用程序被称作一个任务。它支持远大于 CPU 数量的任务同时运行。当然，这些任务实际上并不是真的在同时运行，而是因为系统在很短的时间内，将 CPU 轮流分配给它们，每个任务创建时被分配***\*时间片\****（几十到上百毫秒），任务执行（占用CPU）时，时间片递减。操作系统会在当前任务的时间片用完时调度执行其他任务。这就造成多任务同时运行的错觉。

并不是一个任务运行完了才运行下一个，而是每个任务运行一定的时间，换下一个任务运行。

# CPU上下文切换

![image-20200116163606923](/../assets/images/image-20200116163606923.png)

任务A执行到一半，去执行任务B了，等再回来执行任务A的时候，咋知道执行到哪儿了呢？

靠CPU寄存器 & 程序计数器（PC）—— CPU上下文：

* CPU寄存器：是 CPU 内置的容量小、但速度极快的内存。
* 程序计数器：是用来存储CPU 正在执行的指令位置、或者即将执行的下一条指令位置。

只要把A的CPU上下文记住了，保存下来，等到回来的时候，再把A的上下文加载到寄存器和程序计数器，那么又可以从刚刚断掉的地方接着运行了

这些保存下来的CPU上下文，会被存储在系统内核中。

# Linux操作系统中的任务

任务是一个逻辑概念，指由一个软件完成的活动，或者是为实现某个目的的一系列操作。操作系统管理的“任务”是什么呢？

* 进程是一种任务
* 线程也是一种任务
* 硬件中断（导致中断处理程序的调用）也是一种任务

# CPU上下文切换

* CPU 上下文切换，是保证 Linux 系统正常工作的核心功能之一，一般情况下不需要我们特别关注。
* 但过多的上下文切换，会把 CPU 时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，从而缩短进程真正运行的时间，导致系统的整体性能大幅下降。